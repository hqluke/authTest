<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Log <%= exercise.name %></title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/insertData.css" />
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1><%= exercise.name %></h1>
                <% if (year && month && day) { %>
                    <p class="date-info"><%= month %>/<%= day %>/<%= year %></p>
                <% } %>
            </div>
            
            <form action="/exercise/insertData" method="POST">
                <input type="hidden" name="exerciseId" value="<%= exercise.id %>" />
                <input type="hidden" name="isUpperBody" value="<%= exercise.isupperbody %>" />
                <% if (year && month && day) { %>
                    <input type="hidden" name="year" value="<%= year %>" />
                    <input type="hidden" name="month" value="<%= month %>" />
                    <input type="hidden" name="day" value="<%= day %>" />
                <% } %>
                
                <div class="form-card">
                    <div class="isets">
                        <label for="select-sets">Sets</label>
                        <select name="sets" id="select-sets">
                            <%sets.forEach(set => {%>
                            <option value="<%=set.sets%>"><%=set.sets%></option>
                            <%})%>
                        </select>
                    </div>
                    
                    <div class="iweightsandreps">
                        <div class="iweight">
                            <label for="select-weight">Weight</label>
                            <select name="weight" id="select-weight">
                                <%weights.forEach(weight => {%>
                                <option value="<%=weight.weight%>">
                                    <%=weight.weight%>
                                </option>
                                <%})%>
                            </select>
                        </div>
                        <div class="ireps">
                            <label for="select-reps">Reps</label>
                            <select name="reps" id="select-reps">
                                <%reps.forEach(rep => {%>
                                <option value="<%=rep.reps%>"><%=rep.reps%></option>
                                <%})%>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="button-container">
                    <% if (year && month && day) { %>
                        <a href="/exercise?year=<%= year %>&month=<%= month %>&day=<%= day %>" style="width: 100%; text-decoration: none;">
                            <button type="button" class="btn-back">← Back</button>
                        </a>
                    <% } else { %>
                        <a href="javascript:history.back()" style="width: 100%; text-decoration: none;">
                            <button type="button" class="btn-back">← Back</button>
                        </a>
                    <% } %>
                    <button type="submit" class="btn-submit">Save Workout</button>
                </div>
            </form>
        </div>

        <script>
            const repsData = <%- JSON.stringify(reps) %>;
            const weightData = <%- JSON.stringify(weights) %>;
            const lastData = <%- JSON.stringify(lastData) %>;

            let select = document.getElementById("select-sets");

            document.getElementById("select-sets").addEventListener("change", () => {
                displayNumSets(false);
                displayNumWeight(false);
            });

            const repDiv = document.querySelector(".ireps");
            const weightDiv = document.querySelector(".iweight");

            window.addEventListener("load", () => {
                if (lastData[0]?.sets) {
                    select.value = lastData[0].sets;
                    displayNumSets(true);
                    displayNumWeight(true);
                }
            });

            function displayNumWeight(firstTime){
                while(weightDiv.firstChild){
                    weightDiv.removeChild(weightDiv.lastChild);
                }

                let select = document.getElementById("select-sets");
                selectedSets = select.value;

                for (let i = 0; i <= selectedSets-1; i++) {
                    let num = i + 1;
                    const weightLabel = document.createElement("label");
                    weightLabel.setAttribute("for", "select-weight-" + num);
                    weightLabel.innerText = "Weight " + num;
                    weightDiv.appendChild(weightLabel);

                    const weightSelect = document.createElement("select");
                    weightSelect.setAttribute("name", "weight-" + num);
                    weightSelect.setAttribute("id", "select-weight-" + num);

                    weightData.forEach(weight => {
                        const option = document.createElement("option");
                        option.setAttribute("value", weight.weight);
                        option.innerText = weight.weight;
                        weightSelect.appendChild(option);
                    });

                    if (firstTime && lastData[i]?.weight !== undefined) {
                        weightSelect.value = lastData[i].weight;
                    }
                    else if (lastData[0]?.weight !== undefined) {
                        weightSelect.value = lastData[0].weight;
                    }
                    else{
                        weightSelect.value = weightData[0].weight;
                    }
                    weightDiv.appendChild(weightSelect);
                    cascadeListener("weight");
                }
            }

            function displayNumSets(firstTime){
                while(repDiv.firstChild){
                    repDiv.removeChild(repDiv.lastChild);
                }

                let select = document.getElementById("select-sets");
                let selectedSets = select.value;

                for (let i = 0; i <= selectedSets-1; i++) {
                    let num = i + 1;
                    const repsLabel = document.createElement("label");
                    repsLabel.setAttribute("for", "select-reps-" + num);
                    repsLabel.innerText = "Reps " + num;
                    repDiv.appendChild(repsLabel);

                    const repsSelect = document.createElement("select");
                    repsSelect.setAttribute("name", "reps-" + num);
                    repsSelect.setAttribute("id", "select-reps-" + num);

                    repsData.forEach(rep => {
                        const option = document.createElement("option");
                        option.setAttribute("value", rep.reps);
                        option.innerText = rep.reps;
                        repsSelect.appendChild(option);
                    });

                    if (firstTime && lastData[i]?.reps !== undefined) {
                        repsSelect.value = lastData[i].reps;
                    }
                    else{
                        repsSelect.value = repsData[0].reps;
                    }
                    repDiv.appendChild(repsSelect);
                    cascadeListener("reps");
                }
            }

            function getIndexFromId(id){
                return parseInt(id.split("-").pop(), 10);
            }

            function cascadeListener(type){
                document.querySelectorAll(`select[id^="select-${type}-"]`)
                    .forEach(select => {
                        select.addEventListener("change", (e) => {
                            const sourceIndex = getIndexFromId(e.target.id);
                            const value = e.target.value;

                            document.querySelectorAll(`select[id^="select-${type}-"]`)
                                .forEach(target => {
                                    const targetIndex = getIndexFromId(target.id);
                                    if (targetIndex > sourceIndex) {
                                        target.value = value;
                                    }
                                });
                        });
                    });
            }
        </script>
    </body>
</html>

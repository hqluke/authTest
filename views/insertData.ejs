<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Insert Data</title>
        <link rel="stylesheet" href="/insertData.css" />
    </head>
    <body>
        <h1><%= exercise.name %></h1>
        <form action="/exercise/insertData" method="POST">
            <input type="hidden" name="exerciseId" value="<%= exercise.id %>" />
            <input
                type="hidden"
                name="isUpperBody"
                value="<%= exercise.isupperbody %>"
            />
            <div class="iContainer">
                <div class="isets">
                    <label for="select-sets">Sets</label>
                    <select name="sets" id="select-sets">
                        <%sets.forEach(set => {%>
                        <option value="<%=set.sets%>"><%=set.sets%></option>
                        <%})%>
                    </select>
                </div>
                <div class="iweightsandreps">
                    <div class="iweight">
                        <label for="select-weight">Weight</label>
                        <select name="weight" id="select-weight">
                            <%weights.forEach(weight => {%>
                            <option value="<%=weight.weight%>">
                                <%=weight.weight%>
                            </option>
                            <%})%>
                        </select>
                    </div>
                    <div class="ireps">
                        <label for="select-reps">Reps</label>
                        <select name="reps" id="select-reps">
                            <%reps.forEach(rep => {%>
                            <option value="<%=rep.reps%>"><%=rep.reps%></option>
                            <%})%>
                        </select>
                    </div>
                </div>
            </div>
            <button type="submit">Insert Data</button>
        </form>

        <script>

            //converts the reps data to json so it can be used in the js
                const repsData = <%- JSON.stringify(reps) %>;
                // console.log(repsData);

                const weightData = <%- JSON.stringify(weights) %>;
                // console.log(weightData);

            const lastData = <%- JSON.stringify(lastData) %>;
            console.log(lastData);


            let select = document.getElementById("select-sets");

            document.getElementById("select-sets").addEventListener("change", () => {
                displayNumSets(false);
                displayNumWeight(false);
            });

            const repDiv = document.querySelector(".ireps");
            const weightDiv = document.querySelector(".iweight");

            window.addEventListener("load", () => {

                if (lastData[0]?.sets) {
                    select.value = lastData[0].sets;
                    displayNumSets(true);
                    displayNumWeight(true);
                }
            });

            function displayNumWeight(firstTime){

                console.log("calling num weight");
                while(weightDiv.firstChild){
                    weightDiv.removeChild(weightDiv.lastChild);
                }

                let select = document.getElementById("select-sets");
                selectedSets = select.value;

                for (let i = 0; i <= selectedSets-1; i++) {
                    let num = i + 1;
                    const weightLabel = document.createElement("label");
                    weightLabel.setAttribute("for", "select-weight-" + num);
                    weightLabel.innerText = "Weight " + num;
                    weightDiv.appendChild(weightLabel);

                    const weightSelect = document.createElement("select");
                    weightSelect.setAttribute("name", "weight-" + num);
                    weightSelect.setAttribute("id", "select-weight-" + num);

                        weightData.forEach(weight => {
                            const option = document.createElement("option");
                            option.setAttribute("value", weight.weight);
                            option.innerText = weight.weight;
                            weightSelect.appendChild(option);
                        });

                    if (firstTime && lastData[i]?.weight !== undefined) {
                        weightSelect.value = lastData[i].weight;
                    }
                    else if (lastData[0]?.weight !== undefined) {
                        weightSelect.value = lastData[0].weight;
                    }
                    else{
                        weightSelect.value = weightData[0].weight;
                    }
                    weightDiv.appendChild(weightSelect);
                    cascadeListener("weight");
                }


            }

            function displayNumSets(firstTime){
                console.log("calling num sets");
                while(repDiv.firstChild){
                repDiv.removeChild(repDiv.lastChild);
                }


                let select = document.getElementById("select-sets");
                let selectedSets = select.value;

                for (let i = 0; i <= selectedSets-1; i++) {
                    let num = i + 1;
                    const repsLabel = document.createElement("label");
                    repsLabel.setAttribute("for", "select-reps-" + num);
                    repsLabel.innerText = "Reps " + num;
                    repDiv.appendChild(repsLabel);

                    const repsSelect = document.createElement("select");
                    repsSelect.setAttribute("name", "reps-" + num);
                    repsSelect.setAttribute("id", "select-reps-" + num);

                        repsData.forEach(rep => {
                            const option = document.createElement("option");
                            option.setAttribute("value", rep.reps);
                            option.innerText = rep.reps;
                            repsSelect.appendChild(option);
                        });

                    if (firstTime && lastData[i]?.reps !== undefined) {
                        repsSelect.value = lastData[i].reps;
                    }
                    else{
                        repsSelect.value = repsData[0].reps;
                    }
                    repDiv.appendChild(repsSelect);
                    cascadeListener("reps");
                }
            }

            function getIndexFromId(id){
                return parseInt(id.split("-").pop(), 10);
            }

            function cascadeListener(type){
                document.querySelectorAll(`select[id^="select-${type}-"]`)
                    .forEach(select => {
                        select.addEventListener("change", (e) => {
                            const sourceIndex = getIndexFromId(e.target.id);
                            const value = e.target.value;

                            document.querySelectorAll(`select[id^="select-${type}-"]`)
                                .forEach(target => {
                                    const targetIndex = getIndexFromId(target.id);
                                    if (targetIndex > sourceIndex) {
                                        target.value = value;
                                    }
                                });
                        });
                    });
            }
        </script>
    </body>
</html>
